## `new.py` K线缓存开关使用说明（“今天请求过就复用”）

这份说明对应脚本：[new.py](/Users/daisyhhuang/Documents/stock_project/new.py)

### 你想要的效果是什么
当你扫描全市场时，同一天同一只股票的K线如果**已经请求过一次**：

- 之后再次运行脚本，会**直接读取本地缓存**
- 不会重复请求 iTick
- 也不会触发 `--request-interval` 的等待（只有真实请求 iTick 时才会 sleep）

---

## 1）核心开关参数

### `--cache-kline`
**开启K线缓存**：优先读缓存；没有缓存才请求 iTick；请求到的数据会写入缓存。

- 典型用法：
  - `python3 new.py --cache-kline`

### `--offline`
**离线模式**：只读缓存，不请求 iTick。

- 适合：你想“专门调策略/调条件”，不想再打接口、也不想等。
- 注意：离线模式下会强制开启缓存（等同于自动加上 `--cache-kline`）。
- 典型用法：
  - `python3 new.py --offline`

### `--cache-dir`
缓存目录，默认是 `kline_cache`。

- 典型用法：
  - `python3 new.py --cache-kline --cache-dir /tmp/kline_cache`

### `--cache-date`
指定使用哪一天的缓存目录（格式 `YYYYMMDD`）。默认不传就是“今天”。

- 适合：你昨天跑过全市场，今天想继续用昨天缓存来调策略。
- 典型用法：
  - `python3 new.py --offline --cache-date 20260216`

---

## 2）缓存文件会保存在哪里
默认目录结构：

- `kline_cache/YYYYMMDD/SYMBOL.csv`

例如：

- `kline_cache/20260217/SH600000.csv`
- `kline_cache/20260217/SZ000001.csv`

每个 CSV 保存的是该股票的K线数据（含 `date/open/high/low/close/volume/amount` 等列）。

---

## 3）常用命令组合（直接照抄就能用）

### A. 正常扫描 + 开启缓存（推荐）
第一次会请求并落盘；同一天后续再跑会直接复用。

- `python3 new.py --cache-kline --max-stocks 600 --request-interval 10`

### B. 我已经跑过一次了，现在专门调策略（不打接口）
只读本地缓存。

- `python3 new.py --offline --max-stocks 600`

### C. 使用“昨天”的缓存来离线调策略
- `python3 new.py --offline --cache-date 20260216 --max-stocks 600`

### D. 换缓存目录（例如你想把缓存放到更大的磁盘）
- `python3 new.py --cache-kline --cache-dir /Volumes/Data/kline_cache`

---

## 4）几个注意点（很重要）

- **离线模式不保证有数据**：
  - 如果某只票当天（或你指定的 `--cache-date`）没有缓存文件，离线模式下它会直接跳过。

- **缓存是按“日期目录”分割的**：
  - 默认用今天日期，今天跑出来的缓存只会写到 `kline_cache/今天/` 里。

- **`--request-interval` 只对真实请求生效**：
  - 如果命中缓存（from_cache=True），脚本不会 sleep，所以离线调策略会非常快。

---

## 5）我想确认自己到底有没有在用缓存（怎么观察）
你运行时会看到类似提示：

- `K线缓存：开启（dir=..., date=..., offline=...）`

如果你想更明确（例如打印"from_cache=True/False"），我也可以帮你在 [new.py](/Users/daisyhhuang/Documents/stock_project/new.py) 里加一行 debug 输出（默认不加，避免刷屏）。

---

## 右侧策略筛选条件（2026-02-21更新）

### 当前策略条件
- **启动条件**：昨日收盘 ≤ 昨日MA20 且 今日收盘 > 今日MA5（首次启动）
- **筛选条件**：总分 ≥ 60分（潜力股级别）且 **启动质量分 > 0**
- **今日涨幅**：表现良好

### 启动质量评分标准（满分30分）
- **20分**：昨日收盘 ≤ 昨日MA20 且 今日收盘 > 今日MA5（优秀启动）
- **15分**：昨日收盘 ≤ 昨日MA20 且 今日收盘 > 昨日MA5（良好启动）
- **10分**：昨日收盘 ≤ 昨日MA20 且 今日收盘 > 今日开盘（一般启动）

### 今日候选股结果（2026-02-21）
筛选条件：启动质量分必须 > 0

| 股票代码 | 股票名称 | 总分 | 启动质量分 | 今日涨幅 |
|---------|---------|-----|-----------|----------|
| SZ000021 | 深科技 | 75 | 30 | 4.28% |
| SZ301269 | 江波龙 | 70 | 25 | 3.93% |
| SZ002371 | 北方华创 | 65 | 20 | 2.54% |
| SZ002050 | 三花智控 | 65 | 20 | 2.44% |
| SZ301220 | 佰维存储 | 60 | 15 | 3.55% |

### 策略修改说明
**修改时间**：2026-02-21
**修改内容**：在筛选条件中添加 `launch_score > 0` 要求
**修改原因**：确保只有真正"回踩20线后启动"的股票才能入选，避免像东阳光(SH600673)这样虽然趋势不错但没有回踩动作的股票入选

### 运行命令示例
```bash
# 正常扫描（推荐）
python3 new.py --cache-kline --max-stocks 600

# 离线调策略
python3 new.py --offline --max-stocks 600
```

---

## 策略验证案例

### 东阳光(SH600673)分析
- **日期**：2026-02-03（用户期望的启动K线）
- **昨日收盘**：26.65
- **今日收盘**：29.50
- **问题**：昨日收盘26.65 > 昨日MA20（约25.xx），不满足"回踩20线"条件
- **结果**：启动质量分 = 0，被正确剔除

### 策略优势
- 精准捕捉真正的右侧启动信号
- 避免追高，只选择有回踩动作的股票
- 提高选股质量，减少假信号

---

*最后更新：2026-02-21*
