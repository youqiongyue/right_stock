# `new.py` 当前策略说明文档

> 最后更新：2026-02-28

---

## 一、整体流程

```
全市场股票池（AkShare 静态列表）
        ↓
  取前 600 只（按成交额排序，但当前成交额字段为0，实际为前600只）
        ↓
  逐只获取 K 线（iTick API / 本地缓存）
        ↓
  价格 ≥ 5元 且 成交额 ≥ 3000万（从K线最后一根读取）
        ↓
  计算技术指标（MA5 / MA20 / MA50 / 量比等）
        ↓
  check_conditions 评分模型（100分制）
        ↓
  passed = True → 进入候选股列表
        ↓
  按总分降序输出，保存 CSV
```

---

## 二、技术指标计算

| 指标 | 计算方式 |
|------|---------|
| MA5 | 收盘价5日均线 |
| MA20 | 收盘价20日均线 |
| MA50 | 收盘价50日均线 |
| pct_change_5 | 近5日涨幅（%） |
| pct_change_20 | 近20日涨幅（%） |
| vol_ma20 | 成交量20日均量 |
| vol_ratio | 今日成交量 / vol_ma20 |

> 注意：K线数据不足50根时，直接跳过该股票。

---

## 三、评分模型（100分制）

### 第一维：趋势强度（满分40分）

| 条件 | 得分 |
|------|------|
| MA5 > MA20 > MA50（完整多头排列） | +15分 |
| MA20 > MA50（不含MA5） | +10分 |
| MA50今日 > MA50昨日（MA50上行） | +10分 |
| 收盘 > MA20 | +5分 |
| 收盘 > MA50 | +10分 |

### 第二维：启动质量（满分30分）⚠️ 关键维度

**核心条件（二选一，必须同时满足才能得分）：**

- **条件A**：昨日收盘 < 昨日MA20（昨天还在MA20下方）
- **条件B**：今日收盘 > 今日MA5（今天站上MA5）

| 条件A + 条件B 是否满足 | 基础分 |
|----------------------|--------|
| ✅ 同时满足 | +15分 |
| ❌ 任一不满足 | 0分 |

**在满足基础条件后，叠加今日涨幅分：**

| 今日涨幅 | 额外得分 |
|---------|---------|
| ≥ 5% | +15分 |
| ≥ 3% | +10分 |
| ≥ 1% | +5分 |
| < 1% | 0分 |

> ⚠️ **这是筛选最严的维度**：要求股票"昨天还在MA20下方，今天就突破MA5"，是极罕见的一日反转信号，导致大多数股票在此维度得0分。

### 第三维：资金确认（满分20分）

| 条件 | 得分 |
|------|------|
| 量比 ≥ 1.5（明显放量） | +10分 |
| 量比 ≥ 1.2 | +7分 |
| 量比 ≥ 1.0 | +5分 |
| 今日上涨 且 量比有分 | +10分 |
| 今日上涨 但 量比无分 | +3分 |

### 第四维：安全边际（满分10分）

| 条件（近10日最低价为基准） | 得分 |
|--------------------------|------|
| 当前价 ≤ 近10日最低价 × 1.15（未追高） | +10分 |
| 当前价 ≤ 近10日最低价 × 1.25 | +5分 |
| 当前价 > 近10日最低价 × 1.25（追高） | 0分 |

---

## 四、最终筛选条件（passed = True）

必须**同时满足**以下三个条件：

```
1. 基础趋势底座：MA20 > MA50 且 收盘 > MA50 且 收盘 > MA5
2. 总分 ≥ 60分（潜力股级别）
3. 启动质量分 > 0（必须有回踩MA20后启动的动作）
```

---

## 五、评级标准

| 总分 | 评级 |
|------|------|
| ≥ 80分 | 🔥 主升候选 |
| ≥ 70分 | ⭐ 强势观察 |
| ≥ 60分 | 📌 潜力股 |
| < 60分 | 垃圾信号（不输出） |

---

## 六、当前策略的核心问题

### 问题：为什么600只票只筛出1只？

**根本原因：启动质量维度条件极其苛刻**

```
要求：昨日收盘 < 昨日MA20（昨天在均线下方）
  且：今日收盘 > 今日MA5（今天站上MA5）
```

这意味着股票必须在**一天内**完成从"MA20下方"到"站上MA5"的反转，属于极罕见信号。

**另一个问题：600只票的选取方式**

代码按成交额降序排列，但 `get_a_share_universe_step1()` 返回的数据中成交额字段为0（静态列表无实时行情），导致实际上是随机取了前600只，**并非真正按成交额排序**。

---

## 七、运行命令

```bash
# 正常扫描（推荐，开启缓存）
python3 new.py --cache-kline --max-stocks 600 --request-interval 10

# 离线调策略（只读本地缓存，不打接口）
python3 new.py --offline --max-stocks 600

# 使用指定日期的缓存（如复用2月27日数据）
python3 new.py --offline --cache-date 20260227 --max-stocks 600

# 按指定日期视角运行（K线截断到该日）
python3 new.py --offline --cache-date 20260227 --asof-date 20260227 --max-stocks 600
```

---

## 八、缓存目录结构

```
kline_cache/
  └── 20260227/
        ├── SH600000.csv
        ├── SZ000001.csv
        └── ...（每只股票一个CSV）
```

---

## 九、历史筛选结果

### 2026-02-21 结果

| 股票代码 | 股票名称 | 总分 | 启动分 | 趋势分 | 资金分 | 安全分 |
|---------|---------|------|--------|--------|--------|--------|
| SZ000021 | 深科技 | 75 | 30 | 25 | 15 | 5 |
| SZ301269 | 江波龙 | 70 | 25 | 25 | 15 | 5 |
| SZ002371 | 北方华创 | 65 | 20 | 25 | 15 | 5 |
| SZ002050 | 三花智控 | 65 | 20 | 25 | 15 | 5 |
| SZ301220 | 佰维存储 | 60 | 15 | 25 | 15 | 5 |

### 2026-02-27 结果

| 股票代码 | 股票名称 | 总分 | 备注 |
|---------|---------|------|------|
| （仅1只） | — | — | 启动条件过严导致 |
